-- ============================================================
-- STEP 대수 — Auth 추가 정책
-- Supabase > SQL Editor 에 붙여넣고 Run
-- ============================================================

-- users 테이블: 회원가입 시 INSERT 허용
CREATE POLICY "users_insert_own"
  ON users FOR INSERT
  WITH CHECK (auth.uid() = id);

-- users 테이블: 본인 프로필 읽기
CREATE POLICY "users_select_own"
  ON users FOR SELECT
  USING (auth.uid() = id);

-- users 테이블: 선생님은 모든 학생 프로필 읽기 가능
CREATE POLICY "users_teacher_read_all"
  ON users FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'teacher'
    )
  );

-- submissions 테이블: 본인 기록 INSERT
CREATE POLICY "submissions_insert_own"
  ON submissions FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- submissions 테이블: 본인 기록 SELECT
CREATE POLICY "submissions_select_own"
  ON submissions FOR SELECT
  USING (auth.uid() = user_id);

-- submissions 테이블: 선생님은 모든 학생 기록 읽기
CREATE POLICY "submissions_teacher_read_all"
  ON submissions FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE id = auth.uid() AND role = 'teacher'
    )
  );
